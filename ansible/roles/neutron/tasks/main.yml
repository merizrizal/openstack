---
- name: Reconfigure neutron.conf - set default
  ansible.builtin.replace:
    path: /etc/neutron/neutron.conf
    regexp: "^\\[DEFAULT\\](\n(.*))*?\n*(# Where to store Neutron state files).*"
    replace: "{{ lookup('ansible.builtin.template', 'default.conf.j2') }}"

- name: Reconfigure neutron.conf - set OSLO concurency
  ansible.builtin.replace:
    path: /etc/neutron/neutron.conf
    regexp: "^\\[oslo_concurrency\\](\n(.*))*?\n*(# From oslo.concurrency).*"
    replace: "{{ lookup('ansible.builtin.template', 'oslo_concurrency.conf.j2') }}"

- name: Reconfigure neutron.conf - set Nova
  ansible.builtin.replace:
    path: /etc/neutron/neutron.conf
    regexp: "^\\[nova\\](\n(.*))*?\n*(# Name of Nova region to use).*"
    replace: "{{ lookup('ansible.builtin.template', 'nova.conf.j2') }}"

- name: Reconfigure openvswitch_agent.ini - set ovs
  ansible.builtin.replace:
    path: /etc/neutron/plugins/ml2/openvswitch_agent.ini
    regexp: "^\\[ovs\\](\n(.*))*?\n*(# From neutron.ml2.ovs.agent).*"
    replace: "{{ lookup('ansible.builtin.template', 'ovs.conf.j2') }}"

- name: Reconfigure openvswitch_agent.ini - set agent
  ansible.builtin.replace:
    path: /etc/neutron/plugins/ml2/openvswitch_agent.ini
    regexp: "^\\[agent\\](\n(.*))*?\n*(# From neutron.ml2.ovs.agent).*"
    replace: "{{ lookup('ansible.builtin.template', 'agent.conf.j2') }}"

- name: Reconfigure openvswitch_agent.ini - set security group
  ansible.builtin.replace:
    path: /etc/neutron/plugins/ml2/openvswitch_agent.ini
    regexp: "^\\[securitygroup\\](\n(.*))*?\n*(# From neutron.ml2.ovs.agent).*"
    replace: "{{ lookup('ansible.builtin.template', 'securitygroup.conf.j2') }}"

- name: Reconfigure Nova - set neutron
  ansible.builtin.replace:
    path: /etc/nova/nova.conf
    regexp: "^\\[neutron\\](\n(.*))*?\n*(# Configuration options for neutron).*"
    replace: "{{ lookup('ansible.builtin.template', 'nova_neutron.conf.j2') }}"

- name: Add br-prvdr
  ansible.builtin.shell:
    cmd: |
      ovs-vsctl add-br br-prvdr
      ovs-vsctl add-port br-prvdr {{ provider_interface }}
    executable: /bin/bash
  register: add_br_prvdr
  failed_when: >
    add_br_prvdr.stderr is defined and add_br_prvdr.stderr != ""
    and "already exists on bridge" is not in add_br_prvdr.stderr
  changed_when: add_br_prvdr.rc == 0 and add_br_prvdr.stderr is defined and add_br_prvdr.stderr == ""

- name: Re-configure provider interface
  ansible.builtin.template:
    src: interface.yml.j2
    dest: /etc/netplan/50-vagrant.yaml
    mode: "640"
  register: configure_provider_if

- name: Netplan apply
  ansible.builtin.command:
    cmd: netplan apply
  when: configure_provider_if.changed is defined and configure_provider_if.changed
  changed_when: false
